<Window x:Class="SemiStandard.WPF.EnhancedCMP.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:SemiStandard.WPF.EnhancedCMP.ViewModels"
        mc:Ignorable="d"
        Title="Enhanced CMP Simulator (4 Tools, 7 Wafers) - E90 Process Journey"
        Height="1080" Width="1600"
        Background="#1E1E1E">

    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <Style x:Key="SubStateVisibility" TargetType="Border">
            <Setter Property="Visibility" Value="Visible"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding SubState}" Value="">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- Wafer Pulse Animation -->
        <Storyboard x:Key="WaferPulse" RepeatBehavior="Forever">
            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                             From="1.0" To="0.6" Duration="0:0:1" AutoReverse="True"/>
        </Storyboard>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="220"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="200"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="#2D2D30" Padding="20" CornerRadius="5" Margin="0,0,0,10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0">
                    <TextBlock Text="Enhanced CMP Simulator (4 Tools, 7 Wafers)" FontSize="28" FontWeight="Bold" Foreground="White"/>
                    <TextBlock Text="E90 Wafer Journey: Loadport → WTR1 → Polisher → WTR2 → Cleaner → WTR1 → Loadport"
                               FontSize="14" Foreground="#9CDCFE" Margin="0,5,0,0"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="▶ Start" Command="{Binding StartCommand}"
                            Width="100" Height="40" Margin="5"
                            Background="#0E639C" Foreground="White" FontSize="14" FontWeight="Bold" BorderThickness="0" Cursor="Hand"/>
                    <Button Content="⏹ Stop" Command="{Binding StopCommand}"
                            Width="100" Height="40" Margin="5"
                            Background="#F44336" Foreground="White" FontSize="14" FontWeight="Bold" BorderThickness="0" Cursor="Hand"/>
                    <Button Content="➕ Send Job" Command="{Binding SendJobCommand}"
                            Width="100" Height="40" Margin="5"
                            Background="#4CAF50" Foreground="White" FontSize="14" FontWeight="Bold" BorderThickness="0" Cursor="Hand"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Tool Process Cycles (3 wafers per tool) -->
        <Border Grid.Row="1" Background="#2D2D30" Padding="10" CornerRadius="5" Margin="0,0,0,10">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Tool Process Cycles (3 Wafers per Tool)" FontSize="13" FontWeight="Bold" Foreground="White" Margin="0,0,0,8"/>

                <ItemsControl Grid.Row="1" ItemsSource="{Binding Tools}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="120"/>
                                    <ColumnDefinition Width="150"/>
                                    <ColumnDefinition Width="150"/>
                                    <ColumnDefinition Width="150"/>
                                </Grid.ColumnDefinitions>

                                <!-- Tool ID -->
                                <Border Grid.Column="0" Background="#252526" CornerRadius="3" Padding="8,5">
                                    <TextBlock Text="{Binding ToolId}" FontSize="12" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                                </Border>

                                <!-- Cycle 1 (Current) -->
                                <Border Grid.Column="1" CornerRadius="3" Margin="5,0" Padding="8,5">
                                    <Border.Background>
                                        <SolidColorBrush Color="{Binding Cycle1Color}"/>
                                    </Border.Background>
                                    <TextBlock Text="{Binding Cycle1Text}" FontSize="10" Foreground="White" VerticalAlignment="Center" TextAlignment="Center"/>
                                </Border>

                                <!-- Cycle 2 (Previous 1) -->
                                <Border Grid.Column="2" CornerRadius="3" Margin="5,0" Padding="8,5">
                                    <Border.Background>
                                        <SolidColorBrush Color="{Binding Cycle2Color}"/>
                                    </Border.Background>
                                    <TextBlock Text="{Binding Cycle2Text}" FontSize="10" Foreground="White" VerticalAlignment="Center" TextAlignment="Center"/>
                                </Border>

                                <!-- Cycle 3 (Previous 2) -->
                                <Border Grid.Column="3" CornerRadius="3" Margin="5,0" Padding="8,5">
                                    <Border.Background>
                                        <SolidColorBrush Color="{Binding Cycle3Color}"/>
                                    </Border.Background>
                                    <TextBlock Text="{Binding Cycle3Text}" FontSize="10" Foreground="White" VerticalAlignment="Center" TextAlignment="Center"/>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
        </Border>

        <!-- Tools Grid -->
        <Grid Grid.Row="2">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <ItemsControl ItemsSource="{Binding Tools}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <UniformGrid Rows="2" Columns="2"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="#2D2D30" Margin="5" Padding="10" CornerRadius="5">
                                <StackPanel>
                                    <TextBlock Text="{Binding ToolId}" FontSize="16" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>

                                    <!-- Wafer Visualization -->
                                    <Grid Height="110" Margin="0,8">
                                        <!-- Wafer Circle -->
                                        <Ellipse Width="80" Height="80" HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,5,0,0">
                                            <Ellipse.Style>
                                                <Style TargetType="Ellipse">
                                                    <Setter Property="Fill" Value="#404040"/>
                                                    <Setter Property="Stroke" Value="#606060"/>
                                                    <Setter Property="StrokeThickness" Value="2"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding HasWafer}" Value="True">
                                                            <Setter Property="Fill">
                                                                <Setter.Value>
                                                                    <RadialGradientBrush>
                                                                        <GradientStop Color="{Binding StatusColor}" Offset="0.4"/>
                                                                        <GradientStop Color="#1E1E1E" Offset="1"/>
                                                                    </RadialGradientBrush>
                                                                </Setter.Value>
                                                            </Setter>
                                                            <Setter Property="Stroke">
                                                                <Setter.Value>
                                                                    <SolidColorBrush Color="{Binding StatusColor}"/>
                                                                </Setter.Value>
                                                            </Setter>
                                                            <Setter Property="StrokeThickness" Value="3"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding MainState}" Value="processing">
                                                            <DataTrigger.EnterActions>
                                                                <BeginStoryboard Name="ProcessingPulse" Storyboard="{StaticResource WaferPulse}"/>
                                                            </DataTrigger.EnterActions>
                                                            <DataTrigger.ExitActions>
                                                                <StopStoryboard BeginStoryboardName="ProcessingPulse"/>
                                                            </DataTrigger.ExitActions>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Ellipse.Style>
                                        </Ellipse>

                                        <!-- Wafer ID Text -->
                                        <TextBlock Text="{Binding CurrentWaferId}" FontSize="9" FontWeight="Bold"
                                                   Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,35,0,0"
                                                   Visibility="{Binding HasWafer, Converter={StaticResource BoolToVis}}"/>

                                        <!-- Job ID Label -->
                                        <TextBlock Text="{Binding CurrentJobId}" FontSize="8" Foreground="#9CDCFE"
                                                   HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,50,0,0"
                                                   Visibility="{Binding HasWafer, Converter={StaticResource BoolToVis}}"/>

                                        <!-- Empty Indicator -->
                                        <TextBlock Text="○" FontSize="40" Foreground="#404040"
                                                   HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,25,0,0">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding HasWafer}" Value="False">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>

                                        <!-- E90 Substrate Tracking Label -->
                                        <TextBlock Text="E90" FontSize="7" FontWeight="Bold" Foreground="#4CAF50"
                                                   HorizontalAlignment="Center" VerticalAlignment="Bottom"
                                                   Visibility="{Binding HasWafer, Converter={StaticResource BoolToVis}}"/>
                                    </Grid>

                                    <!-- Main State -->
                                    <Border Height="35" Margin="0,5" CornerRadius="5">
                                        <Border.Background>
                                            <SolidColorBrush Color="{Binding StatusColor}"/>
                                        </Border.Background>
                                        <TextBlock Text="{Binding MainState}" FontSize="14" FontWeight="Bold"
                                                   Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>

                                    <!-- SubState (if exists) -->
                                    <Border Height="18" Margin="0,0,0,5" Style="{StaticResource SubStateVisibility}">
                                        <TextBlock Text="{Binding SubState}" FontSize="10" Foreground="#9CDCFE"
                                                   HorizontalAlignment="Center" VerticalAlignment="Center" TextWrapping="Wrap"/>
                                    </Border>

                                <!-- Metrics -->
                                <Grid Margin="0,5,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Wafers:" Foreground="#808080" Margin="0,3" FontSize="11"/>
                                    <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding WafersProcessed}" Foreground="White" FontWeight="Bold" Margin="5,3,0,3" FontSize="11"/>

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Slurry:" Foreground="#808080" Margin="0,3" FontSize="11"/>
                                    <TextBlock Grid.Row="1" Grid.Column="1" Foreground="White" FontWeight="Bold" Margin="5,3,0,3" FontSize="11">
                                        <TextBlock.Text>
                                            <Binding Path="SlurryLevel" StringFormat="{}{0:F1}%"/>
                                        </TextBlock.Text>
                                    </TextBlock>

                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Pad:" Foreground="#808080" Margin="0,3" FontSize="11"/>
                                    <TextBlock Grid.Row="2" Grid.Column="1" Foreground="White" FontWeight="Bold" Margin="5,3,0,3" FontSize="11">
                                        <TextBlock.Text>
                                            <Binding Path="PadWear" StringFormat="{}{0:F1}%"/>
                                        </TextBlock.Text>
                                    </TextBlock>

                                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Cycle:" Foreground="#808080" Margin="0,3" FontSize="11"/>
                                    <TextBlock Grid.Row="3" Grid.Column="1" Foreground="White" FontWeight="Bold" Margin="5,3,0,3" FontSize="11">
                                        <TextBlock.Text>
                                            <Binding Path="AvgCycleTime" StringFormat="{}{0:F1}s"/>
                                        </TextBlock.Text>
                                    </TextBlock>
                                </Grid>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
            </ScrollViewer>
        </Grid>

        <!-- Event Log -->
        <Border Grid.Row="3" Background="#2D2D30" Padding="15" CornerRadius="5" Margin="0,10,0,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Event Log" FontSize="16" FontWeight="Bold" Foreground="White" Margin="0,0,0,10"/>

                <ListBox Grid.Row="1" ItemsSource="{Binding EventLog}"
                         Background="#1E1E1E" Foreground="#D4D4D4"
                         BorderThickness="0" FontFamily="Consolas" FontSize="12">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="5,2"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Foreground" Value="#D4D4D4"/>
                        </Style>
                    </ListBox.ItemContainerStyle>
                </ListBox>
            </Grid>
        </Border>
    </Grid>
</Window>
